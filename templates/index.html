<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebScraper</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e5e9;
            overflow: hidden;
            width: 100%;
            max-width: 800px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .url-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        .url-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .scrape-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scrape-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .scrape-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .cancel-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .console-section {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            min-height: 200px;
            display: none;
        }

        .console-section.active {
            display: block;
        }

        .console-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: #586069;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .console-output {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #24292e;
            background: #ffffff;
            padding: 12px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            scroll-behavior: smooth;
        }


        .download-section {
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .download-section.active {
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .return-home-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .return-home-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }

        .status-message {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.active {
            display: block;
        }


        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
                <div class="header">
                    <h1>WebScraper</h1>
                </div>
        
        <div class="content">
            <div class="input-section" id="inputSection">
                <div class="input-group">
                    <input 
                        type="url" 
                        id="urlInput" 
                        class="url-input" 
                        placeholder="Enter website URL (e.g., https://example.com)"
                        autocomplete="off"
                    >
                    <button id="scrapeBtn" class="scrape-btn">
                        <i class="fas fa-play"></i>
                        Start Scraping
                    </button>
                    <button id="cancelBtn" class="cancel-btn" style="display: none;">
                        <i class="fas fa-stop"></i>
                        Cancel
                    </button>
                </div>
            </div>

            <div class="status-message" id="statusMessage"></div>

            <div class="console-section" id="consoleSection">
                <div class="console-header">
                    <i class="fas fa-terminal"></i>
                    Live Console Output
                </div>
                <div class="console-output" id="consoleOutput">Waiting for scraping to start...</div>
            </div>

            <div class="download-section" id="downloadSection">
                <div class="action-buttons">
                    <button id="downloadBtn" class="download-btn">
                        <i class="fas fa-download"></i>
                        Download Results (JSON)
                    </button>
                    <button id="returnHomeBtn" class="return-home-btn">
                        <i class="fas fa-home"></i>
                        Return to Home
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Initialize Socket.IO connection with better configuration
        const socket = io({
            transports: ['websocket', 'polling'],
            upgrade: true,
            rememberUpgrade: true,
            timeout: 20000,
            forceNew: false,
            autoConnect: true
        });
        
        // DOM elements
        const urlInput = document.getElementById('urlInput');
        const scrapeBtn = document.getElementById('scrapeBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const inputSection = document.getElementById('inputSection');
        const consoleSection = document.getElementById('consoleSection');
        const downloadSection = document.getElementById('downloadSection');
        const statusMessage = document.getElementById('statusMessage');
        const consoleOutput = document.getElementById('consoleOutput');
        const downloadBtn = document.getElementById('downloadBtn');
        const returnHomeBtn = document.getElementById('returnHomeBtn');

        // State
        let isScraping = false;

        // Event listeners
        scrapeBtn.addEventListener('click', startScraping);
        cancelBtn.addEventListener('click', cancelScraping);
        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                startScraping();
            }
        });
        downloadBtn.addEventListener('click', downloadResults);
        returnHomeBtn.addEventListener('click', returnToHome);

        // Socket event listeners
        socket.on('log_message', (data) => {
            console.log('Log message received:', data.data);
            
            // Append new message immediately
            consoleOutput.textContent += data.data + '\n';
            
            // Auto-scroll to bottom immediately
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        });

        socket.on('scraping_started', (data) => {
            console.log('Scraping started:', data);
            showStatus(`🚀 Started scraping: ${data.url}`, 'success');
        });

        socket.on('scraping_complete', (data) => {
            console.log('Scraping complete event received:', data);
            isScraping = false;
            updateUI();
            showStatus(`✅ Scraping completed! Found ${data.total_items} items.`, 'success');
            downloadSection.classList.add('active');
            console.log('Download section should now be visible');
        });

        socket.on('scraping_error', (data) => {
            isScraping = false;
            updateUI();
            showStatus(`❌ Error: ${data.error}`, 'error');
        });

        socket.on('error', (data) => {
            console.log('WebSocket error:', data);
            showStatus(`❌ Error: ${data.message}`, 'error');
            isScraping = false;
            updateUI();
        });

        socket.on('scraping_cancelled', (data) => {
            isScraping = false;
            updateUI();
            showStatus(`🛑 ${data.message}`, 'warning');
        });

        socket.on('heartbeat', (data) => {
            // Respond to heartbeat to keep connection alive
            socket.emit('heartbeat_response');
        });

        socket.on('connect', () => {
            console.log('✅ Connected to server');
            socket.emit('test', 'Hello from client');
        });

        socket.on('disconnect', () => {
            console.log('❌ Disconnected from server');
        });

        socket.on('connect_error', (error) => {
            console.error('❌ Connection error:', error);
        });

        socket.on('test_response', (data) => {
            console.log('✅ Test response received:', data.message);
        });

        socket.on('reconnect', () => {
            console.log('Reconnected to server');
            // Refresh status when reconnecting
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.is_running) {
                        isScraping = true;
                        updateUI();
                        showStatus(`Resuming scraping: ${data.current_url}`, 'success');
                    }
                });
        });

        function startScraping() {
            const url = urlInput.value.trim();
            if (!url) {
                showStatus('Please enter a valid URL', 'error');
                return;
            }

            isScraping = true;
            updateUI();
            
            // Clear console output
            consoleOutput.textContent = '';
            
            // Send WebSocket message to start scraping
            socket.emit('start_scraping', { url: url });
        }

        function cancelScraping() {
            fetch('/api/cancel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showStatus(data.message, 'warning');
                    isScraping = false;
                    updateUI();
                }
            })
            .catch(error => {
                console.error('Error cancelling scraping:', error);
                showStatus('Error cancelling scraping', 'error');
            });
        }

        function downloadResults() {
            window.location.href = '/api/download';
        }

        function returnToHome() {
            // Reset the UI to initial state
            isScraping = false;
            updateUI();
            
            // Clear the console output
            consoleOutput.textContent = 'Waiting for scraping to start...';
            
            // Clear the status message
            statusMessage.textContent = '';
            statusMessage.className = 'status-message';
            
            // Clear the URL input
            urlInput.value = '';
            
            // Hide the download section
            downloadSection.classList.remove('active');
            
            // Show success message
            showStatus('Ready for a new scraping session!', 'success');
        }


        function updateUI() {
            if (isScraping) {
                inputSection.style.display = 'none';
                consoleSection.classList.add('active');
                downloadSection.classList.remove('active');
                scrapeBtn.disabled = true;
                scrapeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scraping...';
                cancelBtn.style.display = 'flex';
            } else {
                inputSection.style.display = 'block';
                consoleSection.classList.remove('active');
                scrapeBtn.disabled = false;
                scrapeBtn.innerHTML = '<i class="fas fa-play"></i> Start Scraping';
                cancelBtn.style.display = 'none';
            }
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type} active`;
            
            setTimeout(() => {
                statusMessage.classList.remove('active');
            }, 5000);
        }

        // Check initial status on page load
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                console.log('Initial status check:', data);
                if (data.is_running) {
                    console.log('Scraping is already running, updating UI');
                    isScraping = true;
                    updateUI();
                    showStatus(`Resuming scraping: ${data.current_url}`, 'success');
                } else if (data.results_file) {
                    // Show download button if results are available
                    console.log('Results file available, showing download section');
                    downloadSection.classList.add('active');
                }
            });

        // Periodic status check as fallback
        setInterval(() => {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    console.log('Periodic status check:', data);
                    if (data.is_running && !isScraping) {
                        // Scraping started but we missed the event
                        console.log('Periodic check: Scraping is running, updating UI');
                        isScraping = true;
                        updateUI();
                        showStatus(`Resuming scraping: ${data.current_url}`, 'success');
                    } else if (!data.is_running && data.results_file && isScraping) {
                        // Scraping completed
                        console.log('Periodic check: Scraping completed, showing download section');
                        isScraping = false;
                        updateUI();
                        downloadSection.classList.add('active');
                        showStatus(`✅ Scraping completed! Results available for download.`, 'success');
                    }
                })
                .catch(error => console.error('Status check error:', error));
        }, 5000); // Check every 5 seconds
    </script>
</body>
</html>
